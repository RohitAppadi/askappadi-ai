<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Ask Appadi â€“ AI Assistant</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body {
      background: linear-gradient(to right, #0f2027, #203a43, #2c5364);
      color: #f8f9fa;
      padding: 2rem;
      font-family: 'Segoe UI', sans-serif;
    }
    .navbar {
      background: #111;
      border-bottom: 1px solid #444;
    }
    .navbar-brand {
      font-weight: bold;
      color: #00ffd5 !important;
      font-size: 1.5rem;
    }
    .form-label, .form-check-label {
      font-weight: 500;
    }
    .form-control, .form-select {
      background-color: #1e1e2f;
      color: #f8f9fa;
      border: 1px solid #555;
    }
    .form-control::placeholder {
      color: #aaa;
    }
    .btn-primary {
      background-color: #00ffd5;
      border-color: #00ffd5;
      color: #000;
      font-weight: bold;
    }
    .btn-primary:hover {
      background-color: #00c9aa;
      border-color: #00c9aa;
    }
    .btn-success {
      background-color: #28a745;
      border-color: #28a745;
    }
    .list-group-item {
      background-color: #2c2c3c;
      border-color: #444;
      color: #f1f1f1;
    }
    pre {
      background-color: #1e1e2f;
      color: #00ffd5;
      padding: 1rem;
      border-radius: 5px;
      overflow-x: auto;
    }
    footer {
      margin-top: 4rem;
      font-size: 0.9rem;
      color: #aaa;
    }
    .form-text {
      color: #ccc;
    }
  </style>
</head>
<body>
  <nav class="navbar navbar-expand-lg mb-4">
    <div class="container-fluid">
      <a class="navbar-brand" href="/">Ask Appadi</a>
      <div class="collapse navbar-collapse">
        <ul class="navbar-nav me-auto">
          <li class="nav-item"><a class="nav-link text-light" href="/">Home</a></li>
          <li class="nav-item"><a class="nav-link text-light" href="/status">Status</a></li>
        </ul>
        <span class="navbar-text text-light">
          <%= models.length %> Models available
        </span>
      </div>
    </div>
  </nav>

  <div class="container">
    <div class="row">
      <!-- Chat Interface -->
      <div class="col-md-6">
        <h4 style="color:#00ffd5;">Chat Interface</h4>
        <form action="/query" method="POST" enctype="multipart/form-data">
          <!-- Model Dropdown -->
          <div class="mb-3">
            <label for="model" class="form-label">Select AI Model</label>
            <select name="model" id="model" class="form-select">
              <% models.forEach(m => { %>
                <option value="<%= m %>" <%= m === currentModel ? 'selected' : '' %>><%= m %></option>
              <% }) %>
            </select>
            <small class="text-muted">Current: <%= currentModel %></small>
          </div>

          <!-- Task Dropdown -->
          <div class="mb-3">
            <label for="task" class="form-label">Select Task</label>
            <select name="task" id="task" class="form-select">
              <option value="generate_testcase">Generate Test Cases</option>
              <option value="generate_code">Generate Code</option>
              <option value="generate_framework_selenium">Selenium Framework</option>
              <option value="generate_framework_cucumber">Cucumber Framework</option>
              <option value="generate_api">Generate API Spec</option>
            </select>
          </div>

          <!-- Prompt Input -->
          <div class="mb-3">
            <label for="prompt" class="form-label">Your Message</label>
            <textarea name="prompt" id="prompt" rows="5" class="form-control" maxlength="5000" placeholder="Ask a question or describe your concern..."></textarea>
            <div class="form-text"><span id="charCount">0</span>/5000 characters</div>
          </div>

          <!-- File Upload -->
          <div class="mb-3">
            <label for="inputFile" class="form-label">Upload Input File</label>
            <input type="file" name="inputFile" id="inputFile" class="form-control">
          </div>

          <!-- Checkboxes -->
          <div class="form-check mb-2">
            <input class="form-check-input" type="checkbox" name="readFromLocation" id="readFromLocation">
            <label class="form-check-label" for="readFromLocation">Read input from file location</label>
          </div>

          <div class="form-check mb-2">
            <input class="form-check-input" type="checkbox" name="ctrlEnter" id="ctrlEnter">
            <label class="form-check-label" for="ctrlEnter">Ctrl+Enter to send</label>
          </div>

          <!-- Submit -->
          <button type="submit" class="btn btn-primary mt-3">Submit</button>

          <!-- Download Output -->
          <% if (response && response.length > 0) { %>
            <div class="mt-4">
              <a href="/download-output" class="btn btn-success">Download Output</a>
            </div>
          <% } %>
        </form>
      </div>

      <!-- Chat History -->
      <div class="col-md-6">
        <h4 style="color:#00ffd5;">Chat History</h4>
        <% if (history.length === 0) { %>
          <p>No conversations yet! Ask your first question!</p>
        <% } else { %>
          <ul class="list-group">
            <% history.forEach(h => { %>
              <li class="list-group-item">
                <strong><%= h.model %></strong> @ <%= h.timestamp %><br>
                <em>Prompt:</em> <%= h.prompt %><br>
                <em>Response:</em> <pre><%= h.response %></pre>
              </li>
            <% }) %>
          </ul>
        <% } %>
      </div>
    </div>

    <!-- Latest Response -->
    <% if (response && response.length > 0) { %>
      <div class="mt-5">
        <h4 style="color:#00ffd5;">Latest Response</h4>
        <pre><%= response %></pre>
      </div>
    <% } %>

    <!-- Error Message -->
    <% if (error && error.length > 0) { %>
      <div class="alert alert-danger mt-3"><%= error %></div>
    <% } %>

    <!-- Clear Chat History Button -->
    <form action="/clear-history" method="POST" class="mt-4 text-center">
      <button type="submit" class="btn btn-outline-danger btn-sm px-4 py-2">
        ðŸ§¹ Clear Chat History
      </button>
    </form>

  </div> <!-- Added missing closing div for container -->

  <footer class="text-center mt-5">
    Powered by Ollama, Express.js, EJS & Bootstrap 5
  </footer>

  <script>
    const promptInput = document.getElementById('prompt');
    const charCount = document.getElementById('charCount');
    const ctrlEnterCheckbox = document.getElementById('ctrlEnter');
    const form = document.querySelector('form[action="/query"]');

    promptInput.addEventListener('input', () => {
      charCount.textContent = promptInput.value.length;
    });

    // Handle Ctrl+Enter to submit if checkbox is checked
    promptInput.addEventListener('keydown', (e) => {
      if (e.ctrlKey && e.key === 'Enter' && ctrlEnterCheckbox.checked) {
        e.preventDefault();
        form.submit();
      }
    });
  </script>
</body>
</html>
